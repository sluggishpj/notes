---
title: ES2024
---

# ES2024

## Well-Formed Unicode Strings

### ä»€ä¹ˆæ˜¯åŸºæœ¬å¤šæ–‡ç§å¹³é¢ï¼ˆBMPï¼‰ï¼Ÿ

åŸºæœ¬å¤šæ–‡ç§å¹³é¢ï¼ˆBasic Multilingual Planeï¼ŒBMPï¼‰æ˜¯Unicodeå­—ç¬¦é›†ä¸­çš„ä¸€ä¸ªå¹³é¢ï¼Œå…¶ç ç‚¹èŒƒå›´æ˜¯U+0000åˆ°U+FFFFã€‚è¿™ä¸ªå¹³é¢åŒ…å«äº†ç»å¤§å¤šæ•°å¸¸ç”¨çš„Unicodeå­—ç¬¦ï¼ŒåŒ…æ‹¬æ‹‰ä¸å­—æ¯ã€å¸Œè…Šå­—æ¯ã€è¥¿é‡Œå°”å­—æ¯ã€é˜¿æ‹‰ä¼¯æ•°å­—ã€ä¸­æ—¥éŸ©æ–‡å­—ç­‰ã€‚

### ä»€ä¹ˆæ˜¯ä»£ç†å¯¹ï¼Ÿ

JS ä¸­çš„å­—ç¬¦ä¸²æ˜¯ UTF-16 ç¼–ç çš„ã€‚åœ¨UTF-16ç¼–ç ä¸­ï¼Œä»£ç†å¯¹ï¼ˆSurrogate Pairï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç¼–ç æœºåˆ¶ï¼Œç”¨äºè¡¨ç¤ºé‚£äº›è¶…å‡ºåŸºæœ¬å¤šæ–‡ç§å¹³é¢ï¼ˆBMPï¼‰çš„Unicodeå­—ç¬¦ã€‚è¿™äº›å­—ç¬¦çš„Unicodeç ç‚¹é«˜äºU+FFFFï¼Œå› æ­¤æ— æ³•ç”¨ä¸€ä¸ª16ä½çš„UTF-16ç å…ƒæ¥è¡¨ç¤ºã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒUTF-16å¼•å…¥äº†ä»£ç†å¯¹æœºåˆ¶ã€‚

ä»£ç†å¯¹æ˜¯ç”±ä¸¤ä¸ª16ä½çš„ç å…ƒç»„æˆçš„ï¼š
- ä¸€ä¸ªç§°ä¸ºé«˜ä»£ç†ï¼ˆæˆ–é«˜ä»£ç†ç å…ƒï¼‰ï¼Œå…¶ç ç‚¹èŒƒå›´åœ¨U+D800åˆ°U+DBFFä¹‹é—´
- å¦ä¸€ä¸ªç§°ä¸ºä½ä»£ç†ï¼ˆæˆ–ä½ä»£ç†ç å…ƒï¼‰ï¼Œå…¶ç ç‚¹èŒƒå›´åœ¨U+DC00åˆ°U+DFFFä¹‹é—´ã€‚è¿™ä¸¤ä¸ªç å…ƒåˆåœ¨ä¸€èµ·ï¼Œå¯ä»¥è¡¨ç¤ºä¸€ä¸ªè¶…å‡ºBMPçš„Unicodeå­—ç¬¦ã€‚

ä¾‹å¦‚ï¼ŒUnicodeç ç‚¹U+10000ï¼ˆè¿™æ˜¯BMPä¹‹å¤–çš„ç¬¬ä¸€ä¸ªç ç‚¹ï¼‰åœ¨UTF-16ä¸­çš„ç¼–ç å°±æ˜¯é«˜ä»£ç†ç å…ƒU+D800å’Œä½ä»£ç†ç å…ƒU+DC00çš„ç»„åˆï¼Œå³â€œD800 DC00â€ã€‚åŒæ ·ï¼Œç ç‚¹U+10001çš„UTF-16ç¼–ç å°±æ˜¯â€œD800 DC01â€ï¼Œä»¥æ­¤ç±»æ¨ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒUTF-16ç¼–ç èƒ½å¤Ÿå®Œå…¨è¡¨ç¤ºæ‰€æœ‰Unicodeå­—ç¬¦ï¼Œæ— è®ºæ˜¯BMPå†…çš„è¿˜æ˜¯BMPå¤–çš„ã€‚è¿™ç§ä»£ç†å¯¹æœºåˆ¶æ˜¯UTF-16ç¼–ç æ–¹æ¡ˆçš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œä½¿å¾—UTF-16æˆä¸ºä¸€ç§èƒ½å¤Ÿçµæ´»å¤„ç†å„ç§è¯­è¨€å­—ç¬¦çš„ç¼–ç æ–¹å¼ã€‚

### String.prototype.isWellFormed()

`isWellFormed()` æ–¹æ³•ç”¨äºæ£€æŸ¥ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦åŒ…å«æ ¼å¼è‰¯å¥½çš„ Unicode ä»£ç ç‚¹åºåˆ—ã€‚å¦‚æœå­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰ä»£ç†å¯¹éƒ½æ˜¯å®Œæ•´ä¸”æœ‰æ•ˆçš„ï¼Œåˆ™è¿”å› `true`ï¼›å¦‚æœå­˜åœ¨å­¤ç«‹çš„ä»£ç†ç å…ƒï¼ˆå³ä¸æˆå¯¹çš„é«˜ä»£ç†æˆ–ä½ä»£ç†ç å…ƒï¼‰ï¼Œåˆ™è¿”å› `false`ã€‚

#### ç¤ºä¾‹

```js
// æ ¼å¼è‰¯å¥½çš„å­—ç¬¦ä¸²
const wellFormed = "JavaScript";
console.log(wellFormed.isWellFormed()); // true

// åŒ…å«è¡¨æƒ…ç¬¦å·çš„æ ¼å¼è‰¯å¥½å­—ç¬¦ä¸²ï¼ˆè¡¨æƒ…ç¬¦å·é€šå¸¸ç”±ä»£ç†å¯¹è¡¨ç¤ºï¼‰
const emoji = "ğŸ˜Š";
console.log(emoji.isWellFormed()); // true

// æ ¼å¼ä¸è‰¯çš„å­—ç¬¦ä¸²ï¼ˆåŒ…å«å­¤ç«‹çš„é«˜ä»£ç†ç å…ƒï¼‰
const highSurrogate = "\uD800";
console.log(highSurrogate.isWellFormed()); // false

// æ ¼å¼ä¸è‰¯çš„å­—ç¬¦ä¸²ï¼ˆåŒ…å«å­¤ç«‹çš„ä½ä»£ç†ç å…ƒï¼‰
const lowSurrogate = "\uDC00";
console.log(lowSurrogate.isWellFormed()); // false

// æ ¼å¼è‰¯å¥½çš„ä»£ç†å¯¹
const surrogatePair = "\uD83D\uDE0A"; // ç­‰åŒäº "ğŸ˜Š"
console.log(surrogatePair.isWellFormed()); // true

// æ ¼å¼ä¸è‰¯çš„ä»£ç†å¯¹ï¼ˆä»£ç†ç å…ƒä¸åˆæ³•ï¼‰
const invalidSurrogatePair = "\uD800\u0061"; // ä¸åˆæ³•çš„ä»£ç†å¯¹
console.log(invalidSurrogatePair.isWellFormed()); // false
```

### String.prototype.toWellFormed()

`toWellFormed()` æ–¹æ³•è¿”å›ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­æ‰€æœ‰å­¤ç«‹çš„ä»£ç†ç å…ƒéƒ½è¢«æ›¿æ¢ä¸º Unicode æ›¿æ¢å­—ç¬¦ U+FFFD (ï¿½)ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥ä¿®å¤æ ¼å¼ä¸è‰¯çš„ Unicode å­—ç¬¦ä¸²ï¼Œä½¿å…¶æˆä¸ºæ ¼å¼è‰¯å¥½çš„å­—ç¬¦ä¸²ã€‚

- å¦‚æœåŸå­—ç¬¦ä¸²å·²ç»æ˜¯æ ¼å¼è‰¯å¥½çš„ï¼Œåˆ™è¿”å›ä¸åŸå­—ç¬¦ä¸²ç›¸åŒçš„æ–°å­—ç¬¦ä¸²
- å¦‚æœåŸå­—ç¬¦ä¸²åŒ…å«å­¤ç«‹çš„ä»£ç†ç å…ƒï¼Œåˆ™è¿”å›ä¸€ä¸ªæ–°å­—ç¬¦ä¸²ï¼Œå…¶ä¸­è¿™äº›å­¤ç«‹çš„ä»£ç†ç å…ƒè¢«æ›¿æ¢ä¸º U+FFFD(ï¿½)

#### ç¤ºä¾‹

```js
// æ ¼å¼è‰¯å¥½çš„å­—ç¬¦ä¸²ä¿æŒä¸å˜
const wellFormed = "JavaScript";
console.log(wellFormed.toWellFormed()); // "JavaScript"
console.log(wellFormed.toWellFormed() === wellFormed); // trueï¼ˆå†…å®¹ç›¸åŒä½†æ˜¯æ–°å­—ç¬¦ä¸²ï¼‰

// åŒ…å«è¡¨æƒ…ç¬¦å·çš„æ ¼å¼è‰¯å¥½å­—ç¬¦ä¸²ä¿æŒä¸å˜
const emoji = "ğŸ˜Š";
console.log(emoji.toWellFormed()); // "ğŸ˜Š"

// æ ¼å¼ä¸è‰¯çš„å­—ç¬¦ä¸²ï¼ˆåŒ…å«å­¤ç«‹çš„é«˜ä»£ç†ç å…ƒï¼‰è¢«ä¿®å¤
const highSurrogate = "\uD800";
console.log(highSurrogate.toWellFormed()); // "ï¿½"
console.log(highSurrogate.toWellFormed() === "\uFFFD"); // true

// æ ¼å¼ä¸è‰¯çš„å­—ç¬¦ä¸²ï¼ˆåŒ…å«å­¤ç«‹çš„ä½ä»£ç†ç å…ƒï¼‰è¢«ä¿®å¤
const lowSurrogate = "\uDC00";
console.log(lowSurrogate.toWellFormed()); // "ï¿½"

// æ··åˆæ ¼å¼çš„å­—ç¬¦ä¸²
const mixed = "JavaScript \uD800 is \uDC00 awesome";
console.log(mixed.toWellFormed()); // "JavaScript ï¿½ is ï¿½ awesome"

// ä¸ isWellFormed ç»“åˆä½¿ç”¨
function safeProcessString(str) {
  if (!str.isWellFormed()) {
    console.warn("å­—ç¬¦ä¸²æ ¼å¼ä¸è‰¯ï¼Œå·²è‡ªåŠ¨ä¿®å¤");
    return str.toWellFormed();
  }
  return str;
}

const input = "ç”¨æˆ·è¾“å…¥: \uD800";
console.log(safeProcessString(input)); // "ç”¨æˆ·è¾“å…¥: ï¿½"ï¼ˆå¹¶è¾“å‡ºè­¦å‘Šï¼‰
```

- å¯ç”¨äºæ•°æ®æ¸…ç†ï¼šåœ¨å¤„ç†æ¥è‡ªä¸å¯ä¿¡æ¥æºçš„æ–‡æœ¬æ•°æ®æ—¶ï¼Œç¡®ä¿å­—ç¬¦ä¸²æ ¼å¼æ­£ç¡®ã€‚æ¯”å¦‚ `encodeURI`åœ¨ç¼–ç ä¸€ä¸ªéé«˜ - ä½ä½å®Œæ•´çš„ä»£ç†å­—ç¬¦ä¼šæŠ¥é”™ï¼Œå¯ä»¥ä½¿ç”¨ `toWellFormed` å…ˆå¤„ç†æºå­—ç¬¦ä¸²ï¼Œå°±ä¸ä¼šæŠ¥é”™äº†ã€‚


## Atomics.waitAsync()

`Atomics.waitAsync()` æ–¹æ³•æ˜¯ `Atomics.wait()` æ–¹æ³•çš„å¼‚æ­¥ç‰ˆæœ¬ã€‚å®ƒè¿”å›ä¸€ä¸ª `Promise`ï¼Œå½“æŒ‡å®šçš„ç´¢å¼•å¤„çš„å…ƒç´ çš„å€¼æ»¡è¶³ç»™å®šçš„æ¡ä»¶æ—¶ï¼Œè¯¥ `Promise` ä¼šè¢«è§£æã€‚

> Atomics: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Atomics


## RegExp v flag with set notation + properties of strings

### `v` æ ‡å¿—

`v` æ ‡å¿—æ˜¯ ES2024 å¼•å…¥çš„ä¸€ä¸ªæ–°çš„æ­£åˆ™è¡¨è¾¾å¼æ ‡å¿—ï¼Œå®ƒå¯ç”¨äº†ä¸€äº›æ–°çš„ç‰¹æ€§ï¼š

1. é›†åˆè¡¨ç¤ºæ³•
2. å­—ç¬¦ä¸²å±æ€§è½¬ä¹‰

### é›†åˆè¡¨ç¤ºæ³•

`v` æ ‡å¿—å…è®¸ä½¿ç”¨æ›´çµæ´»çš„é›†åˆè¿ç®—ç¬¦æ¥å®šä¹‰å­—ç¬¦ç±»ï¼š

- å¹¶é›†è¿ç®—ï¼šä½¿ç”¨ `||` 
- äº¤é›†è¿ç®—ï¼šä½¿ç”¨ `&&`
- å·®é›†è¿ç®—ï¼šä½¿ç”¨ `--`
- åµŒå¥—é›†åˆï¼šä½¿ç”¨ `[]`

#### ç¤ºä¾‹

```js
// å¹¶é›†è¿ç®—
const vowelRegex = /[aeiou]||[AEIOU]/v;
console.log(vowelRegex.test("Hello")); // true

// äº¤é›†è¿ç®—ï¼šåŒ¹é…æ—¢æ˜¯æ•°å­—åˆæ˜¯å¶æ•°çš„å­—ç¬¦
const evenDigitRegex = /[[\d]&&[02468]]/v;
console.log(evenDigitRegex.test("2")); // true
console.log(evenDigitRegex.test("1")); // false

// å·®é›†è¿ç®—ï¼šåŒ¹é…éæ•°å­—å­—ç¬¦ï¼ˆæ’é™¤æ•°å­—ï¼‰
const nonDigitRegex = /[[\D]--[0-9]]/v;
console.log(nonDigitRegex.test("abc")); // true
console.log(nonDigitRegex.test("123")); // false

// åµŒå¥—é›†åˆ
const alphanumericRegex = /[a-zA-Z]&&[0-9]||[A-Z]&&[a-z]/v;
console.log(alphanumericRegex.test("a1")); // true
```


### å­—ç¬¦ä¸²å±æ€§è½¬ä¹‰

`v` æ ‡å¿—å…è®¸åœ¨å­—ç¬¦ç±»ä¸­ä½¿ç”¨æ›´å¤šå­—ç¬¦ä¸²å±æ€§è½¬ä¹‰ï¼ŒåŒ…æ‹¬ï¼š

- `Basic_Emoji`
- `Emoji_Keycap_Sequence`
- `RGI_Emoji_Modifier_Sequence`
- `RGI_Emoji_Flag_Sequence`
- `RGI_Emoji_Tag_Sequence`
- `RGI_Emoji_ZWJ_Sequence`
- `RGI_Emoji`

#### ç¤ºä¾‹

```js
const re = /^\p{RGI_Emoji}$/v;

// Match an emoji that consists of just 1 code point:
re.test('âš½'); // '\u26BD'
// â†’ true âœ…

// Match an emoji that consists of multiple code points:
re.test('ğŸ‘¨ğŸ¾â€âš•ï¸'); // '\u{1F468}\u{1F3FE}\u200D\u2695\uFE0F'
// â†’ true âœ…
```

### æ³¨æ„äº‹é¡¹

- `v` æ ‡è¯†å®Œå…¨ç‹¬ç«‹äº `u` æ ‡è¯†ï¼ŒäºŒè€…ä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼ˆå¦åˆ™æŠ¥é”™ï¼‰
- å½“iæ ‡è¯†è¢«ä½¿ç”¨æ—¶ï¼Œ`u`å’Œ`v`æ ‡è¯†ç¬¦çš„åŒ¹é…é€»è¾‘ä¸åŒï¼š

> When the `i` flag is set, `\P` character classes are handled slightly differently in `u` and `v` modes. In `u` mode, case-folding happens after subtraction; in `v` mode, case-folding happens before subtraction. More concretely, in `u` mode, `\P{property}` matches `caseFold(allCharacters - charactersWithProperty)`. This means `/\P{Lowercase_Letter}/iu` still matches "a", because A is not a `Lowercase_Letter`. In `v` mode, `\P{property}` matches `caseFold(allCharacters) - caseFold(charactersWithProperty)`. This means `/\P{Lowercase_Letter}/iv` does not match "a", because A is not even in the set of all case-folded Unicode characters.  
> ref: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Regular_expressions/Unicode_character_class_escape

### æ›´å¤šå­—ç¬¦ä¸²å±æ€§è½¬ä¹‰

todo


## REF
> https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/encodeURI  
> https://v8.dev/features/regexp-v-flag
